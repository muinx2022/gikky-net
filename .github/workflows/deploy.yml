name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/

      - name: Detect changed services
        id: changes
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "$FILES"

          if echo "$FILES" | grep -q "^apps/web/\|^packages/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

          if echo "$FILES" | grep -q "^apps/api/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

          if echo "$FILES" | grep -q "^apps/admin/"; then
            echo "admin=true" >> $GITHUB_OUTPUT
          else
            echo "admin=false" >> $GITHUB_OUTPUT
          fi

          if echo "$FILES" | grep -q "^docker-compose.yml$\|^.env"; then
            echo "all=true" >> $GITHUB_OUTPUT
          else
            echo "all=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SSH over Cloudflare Tunnel
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ssh.gikky.net
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          proxy_host: ssh.gikky.net
          envs: CHANGED_FRONTEND,CHANGED_BACKEND,CHANGED_ADMIN,CHANGED_ALL
          script: |
            cd ~/projects/gikky-net
            git pull origin main

            if [ "$CHANGED_ALL" = "true" ]; then
              echo "==> Rebuilding all services..."
              docker compose up -d --build
            else
              if [ "$CHANGED_FRONTEND" = "true" ]; then
                echo "==> Rebuilding frontend..."
                docker compose up -d --build frontend
              fi
              if [ "$CHANGED_BACKEND" = "true" ]; then
                echo "==> Rebuilding backend..."
                docker compose up -d --build backend
              fi
              if [ "$CHANGED_ADMIN" = "true" ]; then
                echo "==> Rebuilding admin..."
                docker compose up -d --build admin
              fi
            fi

            echo "==> Running containers:"
            docker compose ps
        env:
          CHANGED_FRONTEND: ${{ steps.changes.outputs.frontend }}
          CHANGED_BACKEND: ${{ steps.changes.outputs.backend }}
          CHANGED_ADMIN: ${{ steps.changes.outputs.refne }}
          CHANGED_ALL: ${{ steps.changes.outputs.all }}
